---
title: "Acer Microbiome to Phyloseq"
output: html_notebook
---
###load packages
Updated 3/9/21 for code to work with R version 4.1.1 (2021-08-10)
```{r}
set.seed(100)
#library("devtools")
library("ggmap")
library("plotrix")
library("sf")
library("rgdal")
library("tidyverse")
library("taxa")
library("phyloseq")
library("ggplot2")
library("vegan")
library("ggpubr")
library("sciplot")
library("multcompView")
library("patchwork")
library("pacman")
library("ggrepel")
library("paletteer")
library("plyr")
library("grid")
library("reshape2")
library("scales")
library("magrittr") 
library("ape") 
library("RColorBrewer")
library("tidyverse")
library("corncob")
library(forcats)
windowsFonts("Times New Roman" = windowsFont("Times New Roman"))

```

### Get the data and make full dataset phyloseq objects
```{r}
ps_acer<-readRDS("acer_ps_rename_rare.rds")
ps_acer
ps_acer_norare<-readRDS("acer_ps_rename.rds")
ps_acer_norare
d<-data.frame()
d <- data.frame(sample_data(ps_acer))
d[d$Region=="Middle Keys",]$Outlier<-"No" #wasn't saved in phyloseq object used so have to add now
#add the time spent in nursery columns
di<-read.csv("acer_metadata_update_1_21_2021.csv")
di<-di[1:74,15:17]
d <- cbind(d, di)
sample_data(ps_acer)<-d

```

## Now subset the phyloseq object
```{r}
ps_lowno<-subset_samples(ps_acer,Outlier!="Yes"&Region=="Lower Keys")
ps_upno<-subset_samples(ps_acer,Outlier!="Yes"&Region=="Upper Keys")
ps_midno<-subset_samples(ps_acer,Outlier!="Yes"&Region=="Middle Keys")
ps_noout<-subset_samples(ps_acer,Outlier!="Yes")
ps_justout<-subset_samples(ps_acer,Outlier=="Yes")
ps_low<-subset_samples(ps_acer,Region=="Lower Keys")
ps_up<-subset_samples(ps_acer,Region=="Upper Keys")
ps_mid<-subset_samples(ps_acer,Region=="Middle Keys")
ps_noout<-merge_phyloseq(ps_lowno,ps_upno,ps_mid)
ps_lowout<-subset_samples(ps_acer,Outlier=="Yes"&Region=="Lower Keys")
ps_upout<-subset_samples(ps_acer,Outlier=="Yes"&Region=="Upper Keys")

#simplify names to go with later code
ps<-ps_acer #full dataset
psout<-ps_justout #just outliers
psnoout<-ps_noout #no outliers

```


### transform full dataset to bray curtis distance and run PERMANOVA
```{r}
perma<- function(p){ #needs a phyloseq object
  df = as(sample_data(p), "data.frame")
  d = phyloseq::distance(p, "bray")
  df$Site <- as.factor(df$Region)
  PERMANOVA <- adonis2(d ~ Site, df)
  PERMANOVA
}
print("full dataset")
permfull<-perma(ps)
permfull

print("outlier dataset")
permout<-perma(psout)
permout

print("no outlier dataset")
permnoout<-perma(psnoout)
permnoout
```

#### set colors for plots
```{r}
df <- sample_data(ps_acer)
length(levels(factor(df$Region)))
mycolors <- c("red","purple","blue")
names(mycolors)<-levels(factor(df$Region))
mycolors
```
### full dataset NMDS plot
```{r}
full_ord<-ordinate(ps, "NMDS","bray", autotransform = FALSE, parallel = 48, trymax=10^4, maxit = 10^4)
out_ord<-ordinate(psout, "NMDS","bray", autotransform = FALSE, parallel = 48, trymax = 10^4, maxit = 10^4)
noout_ord<-ordinate(psnoout, "NMDS","bray", autotransform = FALSE, parallel = 48, trymax = 10^4, maxit = 10^4)

full_ord
out_ord
noout_ord
```


```{r}

full_nMDS <- plot_ordination(ps,full_ord , color = "Region") +  
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))+
  geom_point(size=2) +
  theme_set(theme_bw())+
  stat_ellipse(aes(fill="Region"))+
  theme(legend.position = "none")+
  stat_ellipse(aes(fill="Region"))+ theme(text = element_text(family = "Times New Roman",size=12))

print(full_nMDS)

outlier_nMDS <- plot_ordination(psout,out_ord , color = "Region") + 
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))   +
  geom_point(size=2) +
  theme_set(theme_bw())+
  stat_ellipse(aes(fill="Region"))+
  theme(legend.position = "none")+
  stat_ellipse(aes(fill="Region"))+ theme(text = element_text(family = "Times New Roman",size=12))

print(outlier_nMDS)

noout_nMDS <- plot_ordination(psnoout,noout_ord , color = "Region") +  
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))   +
  geom_point(size=2) + 
  theme_set(theme_bw())+
  theme(legend.position = "right",legend.title=element_blank())+
  #guides(color=guide_legend(ncol=2))+
  stat_ellipse(aes(fill="Region"))+ theme(text = element_text(family = "Times New Roman",size=12))

print(noout_nMDS)

Fig2 <- full_nMDS + noout_nMDS+ outlier_nMDS + plot_annotation(tag_levels="A")+plot_layout(guides='collect')
Fig2
#ggsave("Figure3.png", plot = Fig2, width = 20, height = 10, units = "cm", dpi = 300)
```
It says probable convergence error, but the ordinate() results all worked and the stress values are good.


## betadisper

```{r,fig.width=10}

par(mfrow = c(1, 2),family="Times New Roman")
p<-psnoout # nooutlier dataset
sampledf<-data.frame(sample_data(p))
sampledf$Region <- as.factor(sampledf$Region)
d_mat<-phyloseq::distance(p, "bray")
g_mod<-with(sampledf,betadisper(d_mat,Region))
#boxplot(g_mod)
mod.tukey<-TukeyHSD(g_mod)
print(mod.tukey)
labels <- multcompLetters(mod.tukey$group[, "p adj"])$Letters # Fix the order of the labels
labels <- labels[order(names(labels))]
bp<-boxplot(g_mod, ylim = c(0,.25), xlab=" ",cex.lab=1.5,cex.axis=1.2)
text( x=c(1:3),y=bp$stats[nrow(bp$stats),] + 0.05, labels,col="red",cex=1.5) #add labels
title(outer=TRUE,main="A",cex.main=1.5,line=-1.7,adj=0.01)
gmod_noout<-g_mod

p<-psout # outlier dataset
sampledf<-data.frame(sample_data(p))
sampledf$Region <- as.factor(sampledf$Region)
d_mat<-phyloseq::distance(p, "bray")
g_mod<-with(sampledf,betadisper(d_mat,Region))
#boxplot(g_mod)
anova(g_mod)
bp<-boxplot(g_mod, ylim = c(0,.85), xlab=" ",cex.lab=1.5,cex.axis=1.2,ylab="")
text( x=c(1:3),y=bp$stats[nrow(bp$stats),] + 0.05, "a",col="red",cex=1.5) #add labels
title(outer=TRUE,main="B",cex.main=1.5,line=-1.7,adj=.5)
gmod_out<-g_mod

```
...Same but now prettier.
```{r}
DF_noout <- data.frame(group = gmod_noout$group, distances = gmod_noout$distances)
beta_noout<-DF_noout%>%ggplot(aes(group,distances,color=group)) +
  geom_boxplot() + 
  geom_point(aes(color = group), position = position_jitter(width=.2, height=0), size = 1,alpha=0.3) +
  theme_bw()+
  xlab("") + 
  theme(legend.position="none")+ 
  theme(text = element_text(size=12))+
  ylab("Distance to Centroid")  + 
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +  
  theme(strip.text.x = element_text(size = 12))+
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))+ theme(text = element_text(family = "Times New Roman",size=12))+
  annotate("text", x = 1, y=.13, label = "b")+
  annotate("text", x = 2, y=.11, label = "ab")+
  annotate("text", x = 3, y=.175, label = "a")

DF_out <- data.frame(group = gmod_out$group, distances = gmod_out$distances)
beta_out<-DF_out%>%ggplot(aes(group,distances,color=group)) +
  geom_boxplot() + 
  geom_point(aes(color = group), position = position_jitter(width=.2, height=0), size = 1,alpha=0.3) +
  theme_bw()+
  xlab("") + 
  theme(legend.position="none")+ 
  theme(text = element_text(size=12))+
  ylab("")  + 
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +  
  theme(strip.text.x = element_text(size = 12))+
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))+ theme(text = element_text(family = "Times New Roman",size=12))+
  annotate("text", x = 1, y=.65, label = "a")+
  annotate("text", x = 2, y=.35, label = "a")

Fig4 <- beta_noout +beta_out + plot_annotation(tag_levels="A")+plot_layout(guides='collect')
Fig4
#ggsave("Figure4.png", plot = Fig4, width = 20, height = 10, units = "cm", dpi = 300)

```

Now the full dataset betadisper analysis:
```{r}
p<-ps #full dataset
sampledf<-data.frame(sample_data(p))
sampledf$Region <- as.factor(sampledf$Region)
d_mat<-phyloseq::distance(p, "bray")
g_mod<-with(sampledf,betadisper(d_mat,Region))
boxplot(g_mod)
mod.tukey<-TukeyHSD(g_mod)
print(mod.tukey)
labels <- multcompLetters(mod.tukey$group[, "p adj"])$Letters # Fix the order of the labels
labels <- labels[order(names(labels))]
bp<-boxplot(g_mod, ylim = c(0,1), xlab="Collection Region")
text( x=c(1:3),y=bp$stats[nrow(bp$stats),] + 0.05, labels,col="red") #add labels

DF_full <- data.frame(group = g_mod$group, distances = g_mod$distances)
DF_full%>%ggplot(aes(group,distances,color=group)) +
  geom_boxplot() + 
  geom_point(aes(color = group), position = position_jitter(width=.2, height=0), size = 1,alpha=0.3) +
  theme_bw()+
  xlab("") + 
  theme(legend.position="none")+ 
  theme(text = element_text(size=12))+
  ylab("")  + 
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +  
  theme(strip.text.x = element_text(size = 12))+
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))+ theme(text = element_text(family = "Times New Roman",size=12))+
  annotate("text", x = 1, y=.65, label = "ab")+
  annotate("text", x = 2, y=.35, label = "a")+
  annotate("text",x=3,y=1,label="b")

```

## Visualizing relative abundances

```{r}
# transform to relative abundance
ps_rel = phyloseq::filter_taxa(ps_acer, function(x) mean(x) > 0.1, TRUE)
ps_rel = transform_sample_counts(ps_rel, function(x) x / sum(x) )
samdf<-data.frame(sample_data(ps_rel))
samdf$out.num<-c()
samdf<-samdf%>%
  mutate(out.num= if_else(Outlier=="Yes",2,1))
sample_data(ps_rel)<-samdf
# melt the data at the Genus level
ps_rel_genus_melt <- ps_rel %>%
  tax_glom(taxrank = "Genus") %>%
  psmelt()
head(ps_rel_genus_melt)

# Get genera with mean relative abundance >0.001 across all samples 
genus_sum <- ps_rel_genus_melt %>% group_by(Genus) %>% dplyr::summarise(Aver = mean(Abundance))
genus_sub <- genus_sum[which(genus_sum$Aver > 0.001),]
names <- genus_sub$Genus
# Replace genera with <0.01 abundance with "NA"
ps_rel_genus_melt$genus <- ps_rel_genus_melt$Genus

ps_rel_genus_melt$genus[ps_rel_genus_melt$genus != "Aquarickettsia" & 
                           ps_rel_genus_melt$genus != "Enterococcus" &
                           ps_rel_genus_melt$genus != "Unclassified_ASV_3" &
                           ps_rel_genus_melt$genus != "Unclassified_ASV_6" &
                           ps_rel_genus_melt$genus != "Family_Helicobacteraceae" &
                           ps_rel_genus_melt$genus != "Family_P3OB-42" &
                           ps_rel_genus_melt$genus != "Romboutsia" &
                           ps_rel_genus_melt$genus != "Spirochaeta_2" &
                           ps_rel_genus_melt$genus != "Unclassified_ASV_13"] <- "low abundance"
#ps_rel_genus_melt$Outlier<-as.factor(ps_rel_genus_melt$Outlier)
  
ps_rel_genus_melt$X2020_Mote_ID <-as.factor(ps_rel_genus_melt$X2020_Mote_ID)

# plot
bar_species = ggplot(ps_rel_genus_melt, aes(x = forcats::fct_reorder(X2020_Mote_ID, out.num), y=Abundance)) + 
  geom_bar(stat="identity", position="fill", aes(fill = with(ps_rel_genus_melt,reorder(genus, Abundance)))) +
  scale_fill_manual(values=c("#1B9E77","#0072B2", "#56B4E9","#E69F00","#660066", "#CC3300", "#FFFF00", "#CC79A7","dark grey","light grey"), 
                    breaks = c("Aquarickettsia","Enterococcus","Unclassified_ASV_3","Unclassified_ASV_6","Family_Helicobacteraceae","Family_P3OB-42","Romboutsia","Spirochaeta_2", "Unclassified_ASV_13","low abundance"),
                    labels = c("Aquarickettsia","Enterococcus","Unclassified_ASV_3","Unclassified_ASV_6","Family_Helicobacteraceae","Family_P3OB-42","Romboutsia","Spirochaeta_2", "Unclassified_ASV_13","low abundance")) +
  facet_grid(~Region, scales = "free_x", space = "free_x") +
  theme_bw() +
  theme(legend.text = element_text(face = "italic")) +
  ylab("Relative Abundance") +
  xlab("2020 Mote ID") +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) +
  #theme(aspect.ratio = 40) +
  theme(strip.text.x = element_text(size = 13)) +
  theme(legend.text=element_text(size=10)) +
  theme(title=element_text(size=14, hjust=0.5),
        axis.title=element_text(size=14),
        axis.text = element_text(size=10)) +
  labs(fill = "Genus", size = "Genus")

bar_species
#ggsave(filename="Figure2.png", plot=bar_species,width=35, height=20 , units="cm",device="png", dpi=300)

```



## Alpha Diversity
### calculate full dataset diversity measures
```{r}
myalphamets<-function(TEST){
  asvnew<-as.matrix((data.frame(otu_table(TEST))))
  samdf<-data.frame(sample_data(TEST))
  rich1 <- specnumber(asvnew)#calculates richness from css
  length(rich1)
  shannon1 <- vegan::diversity(asvnew,"shannon")
  length(shannon1)
  invsimp1 <- vegan::diversity(asvnew, "inv")
  length(invsimp1)
  alpha_coral <- data.frame()
  alpha_coral <- cbind(rich1, shannon1, invsimp1,samdf)
  alpha_coral <- rownames_to_column(alpha_coral, var = "id")
  alpha_coral <- data.frame(alpha_coral) #back to dataframe from matrix
  return(alpha_coral)
}
full_alpha<-myalphamets(ps)
out_alpha<-myalphamets(psout)
noout_alpha<-myalphamets(psnoout)
```

```{r}
full_ric <- full_alpha %>% ggplot(aes(Region,rich1)) +
  geom_boxplot() + 
  xlab("Location") + 
  theme(legend.position="none")+ 
  theme(text = element_text(size=12))+
  ylab("Species Richness")  + 
  theme(axis.text.x = element_text(angle = 90)) +  
  theme(legend.text=element_text(size=12), legend.position = "bottom",text = element_text(size=12),strip.text= element_text(size=12)) +
  #
  #facet_grid(~Outlier,space="free_x",scales="free_x",drop=TRUE) + 
  theme(strip.text.x = element_text(size = 8))
full_ric


full_alpha$Outlier<-factor(full_alpha$Outlier,levels=c("No","Yes"),labels=c("No"="high-Aquarickettsia","Yes"="low-Aquarickettsia"))
ric_ann_text<-data.frame(Region=c("Lower Keys","Middle Keys","Upper Keys","Lower Keys","Upper Keys"),rich1=c(150,80,100,150,175),Outlier=c("high-Aquarickettsia","high-Aquarickettsia","high-Aquarickettsia","low-Aquarickettsia","low-Aquarickettsia"),label=c("a","b","b","a","a"))

ric <- full_alpha %>% ggplot(aes(Region,rich1,color=Region)) +
  geom_boxplot() + 
  geom_point(aes(color = Region), position = position_jitter(width=.2, height=0), size = 1,alpha=0.3) +
  theme_bw()+
  xlab("") + 
  theme(legend.position="none")+ 
  theme(text = element_text(size=12))+
  ylab("Species Richness")  + 
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +  
  facet_grid(~Outlier,space="free_x",scales="free_x",drop=TRUE) + 
  theme(strip.text.x = element_text(size = 8))+
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))+ 
  theme(text = element_text(family = "Times New Roman",size=12))+
  geom_text(data = ric_ann_text,label=ric_ann_text$label,color="black")
ric
# outliers are not sig dif by region
# 
#rich no out  a, b, b
#shannon no out a, ab, b 
```

```{r}
div_ann_text<-data.frame(Region=c("Lower Keys","Middle Keys","Upper Keys","Lower Keys","Upper Keys"),shannon1=c(1,1,1,3,1.5),Outlier=c("high-Aquarickettsia","high-Aquarickettsia","high-Aquarickettsia","low-Aquarickettsia","low-Aquarickettsia"),label=c("a","ab","b","a","a"))

div <- full_alpha %>% ggplot(aes(Region,shannon1,color=Region)) +
  geom_boxplot() + 
  geom_point(aes(color = Region), position = position_jitter(width=.2, height=0), size = 1,alpha=0.3) +
  theme_bw()+
  xlab("") + 
  theme(legend.position="none")+ 
  theme(text = element_text(size=12))+
  ylab("Shannon Diversity")  + 
  theme(axis.text.x = element_text(angle = 45,hjust=1)) +  
  facet_grid(~Outlier,space="free_x",scales="free_x",drop=TRUE) + 
  theme(strip.text.x = element_text(size = 8))+
  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "darkorchid1", "Upper Keys" = "blue"))+theme(text = element_text(family = "Times New Roman",size=12))+
  geom_text(data = div_ann_text,label=div_ann_text$label,color="black")
div

#outliers are not sig dif by region

```

```{r}
fig5<-ric+div+plot_annotation(tag_levels="A")+plot_layout(guides='collect')
fig5
#ggsave("Figure5.png", plot = fig5, width = 20, height = 10, units = "cm", dpi = 300)

```


#### Stats on Alpha Diversity
```{r}
print("full dataset")
kruskal.test(rich1~Region,data=full_alpha)
print("outlier dataset")
kruskal.test(rich1~Region,data=out_alpha)
print("no outlier dataset")
kruskal.test(rich1~Region,data=noout_alpha)
print("out vs no out")
kruskal.test(rich1~Outlier,data=full_alpha)
```


```{r}
print("full dataset")
kruskal.test(shannon1~Region,data=full_alpha)
print("outlier dataset")
kruskal.test(shannon1~Region,data=out_alpha)
print("no outlier dataset")
kruskal.test(shannon1~Region,data=noout_alpha)
print("out vs no out")
kruskal.test(shannon1~Outlier,data=full_alpha)
```

#### posthoc richness
```{r}
richpairkruskal<-function(alp){
  sampledf<-data.frame(sample_data(ps))
  sampledf$Region<-as.factor(sampledf$Region)
  region.list<-levels(sampledf$Region)
  region.list
  aovresults<-c()
  pvals<-c()
  locations<-c()
  for (i in 1:length(region.list)){
    region.leftout<-region.list[i]
    alph_sub<-subset(alp,Region!=region.leftout) #instead of subset_samples use a subset() for the dataframe you are working with
    #d.sub<-phyloseq::distance(ps_sub, "bray") # won't need this for kruskal
    #df.new<-subset(sampledf,subset=Region!=region.leftout) # won't need this either
    PERM<-kruskal.test(rich1~Region,alph_sub) #change to kruskal
    print(PERM)
    pvals<-c(pvals,PERM$'p.value') #this will change. run a kruskal and save the output to do str(output) to see what it call's the pvalues that it outputs.
    #aovresults<-rbind(aovresults,PERM$aov.tab) 
    loc.sub<-region.list[-i]
    locations<-rbind(locations,c(loc.sub))
  }
  aovresults
  combinedtest<-cbind(locations,pvals)
  mult_perm<-data.frame(combinedtest)
  mult_perm
  mult_perm$pvaladj<-p.adjust(mult_perm$pvals,method="bonferroni")
  mult_perm
}
fullrichpair<-richpairkruskal(full_alpha)
fullrichpair
nooutrichpair<-richpairkruskal(noout_alpha)
nooutrichpair
###NO OUTLIERS INCLUDED SINCE ONLY 2 GROUPS (LOW AND UP)
```
#rich no out  a, b, b
#shannon no out a, ab, b 

#### posthoc shannon
```{r}
shanpairkruskal<-function(alp){
  sampledf<-data.frame(sample_data(ps))
  sampledf$Region<-as.factor(sampledf$Region)
  region.list<-levels(sampledf$Region)
  region.list
  aovresults<-c()
  pvals<-c()
  locations<-c()
  for (i in 1:length(region.list)){
    region.leftout<-region.list[i]
    alph_sub<-subset(alp,Region!=region.leftout) #instead of subset_samples use a subset() for the dataframe you are working with
    #d.sub<-phyloseq::distance(ps_sub, "bray") # won't need this for kruskal
    #df.new<-subset(sampledf,subset=Region!=region.leftout) # won't need this either
    PERM<-kruskal.test(shannon1~Region,alph_sub) #change to kruskal
    print(PERM)
    pvals<-c(pvals,PERM$'p.value') #this will change. run a kruskal and save the output to do str(output) to see what it call's the pvalues that it outputs.
    #aovresults<-rbind(aovresults,PERM$aov.tab) 
    loc.sub<-region.list[-i]
    locations<-rbind(locations,c(loc.sub))
  }
  aovresults
  combinedtest<-cbind(locations,pvals)
  mult_perm<-data.frame(combinedtest)
  mult_perm
  mult_perm$pvaladj<-p.adjust(mult_perm$pvals,method="bonferroni")
  mult_perm
}
fullshanpair<-shanpairkruskal(full_alpha)
fullshanpair
nooutshanpair<-shanpairkruskal(noout_alpha)
nooutshanpair
###NO OUTLIERS INCLUDED SINCE ONLY 2 GROUPS (LOW AND UP)
```
#### Corncob
Use unrarified data
```{r}
sample_data(ps_acer_norare)$Outlier<-sample_data(ps_acer)$Outlier
ps_noout_nr<-subset_samples(ps_acer_norare,Outlier!="Yes")
ps_noout_nr
ps_noout
ps_out_nr<-subset_samples(ps_acer_norare,Outlier=="Yes")
ps_out_nr
```

```{r}
set.seed(1)
da_analysis_nr<-differentialTest(formula = ~Region,
                              phi.formula = ~Region,
                              formula_null = ~1,
                              phi.formula_null = ~1,
                              test="Wald",
                              boot=FALSE,
                              data=ps_noout_nr,
                              fdr_cutoff = 0.05)
```
 
```{r}
da_analysis_nr
da_analysis_nr$significant_models
plot(da_analysis_nr,level="Genus")
```


```{r}
da_analysis_out<-differentialTest(formula = ~Region,
                              phi.formula = ~Region,
                              formula_null = ~1,
                              phi.formula_null = ~1,
                              test="Wald",
                              boot=FALSE,
                              data=ps_out_nr,
                              fdr_cutoff = 0.05)
```
 

```{r}
da_analysis_out$significant_taxa
da_analysis_out$significant_models
plot(da_analysis_out,level="Genus")


```


```{r}
#from Becker et al in review
#Write a function to extract the significant taxa and put it in a dataframe with a for loop so you can rearrange the levels of the taxa to make a nice ordered graph. 
da_analysis_nr$significant_models[[2]]$coefficients

sigtaxto_df_2options <- function(daout, psobj,uporlow) {#2 or 3
  df.out <- c()
  for (i in 1:length(daout$significant_models)) { #from 1 to the number of significant taxa
  df.out = rbind(df.out, daout$significant_models[[i]]$coefficients[uporlow, 1:4])
  #bind the sig.mcav row with coefficient, std. error, t value, Pr thing. coefficients[2,] is the DA model output.
  }
  asv = as.vector(daout$significant_taxa) #get significant ASVs
  Class = as.vector(otu_to_taxonomy(data = psobj, daout$significant_taxa, level = c("Class"))) #isolate class of significant Asvs
  Order = as.vector(otu_to_taxonomy(data = psobj, daout$significant_taxa, level = c("Order"))) #isolate order of significant ASVs
  Family = as.vector(otu_to_taxonomy(data = psobj, daout$significant_taxa, level = c("Family"))) #isolate family of significant ASVs
  Family.fix = ifelse(Family == "", "unclassified", Family) #replace empty values with "unclassified"
  Genus = as.vector(otu_to_taxonomy(data = psobj, daout$significant_taxa, level = c("Genus"))) #isolate Genus of singnificant ASVs
  Genus.fix = ifelse(Genus == "", "unclassified", Genus) #replace empty values with "unclassified"
  
  df.bind <- as.data.frame(cbind(df.out, asv, Class, Order, Family.fix, Genus.fix)) #bind taxonomic info together, making sure to use the vectors with "unclassified"
  df.bind$asvgenus <- paste0(df.bind$Genus.fix, " (", df.bind$asv, ")") #make a concatenated column of ASV and Genus.
  colnames(df.bind) <- c("Estimate", "StdError", "tvalue", "Pr", "asv", "Class", "Order", "Family", "Genus", "asvtaxa")
  df.bind$Estimate = as.numeric(as.character(df.bind$Estimate)) #estimate column should be numeric 
  df.bind$StdError = as.numeric(as.character(df.bind$StdError)) #stderror column should be numeric 
  
  return(df.bind)
}


mid.forgraph <- sigtaxto_df_2options(da_analysis_nr, ps_noout_nr,2) #make a df of the corncob output and the taxonomy
#Change the levels of the $asvtaxa row so that it reorders the plot by decreasing coefficients
#mid.forgraph <- mid.forgraph[order(mid.forgraph$Estimate), ]
mid.forgraph$asvtaxa <- factor(mid.forgraph$asvtaxa, levels = as.vector(mid.forgraph$asvtaxa))


up.forgraph <- sigtaxto_df_2options(da_analysis_nr, ps_noout_nr,3) #make a df of the corncob output and the taxonomy
#Change the levels of the $asvtaxa row so that it reorders the plot by decreasing coefficients
#up.forgraph <- up.forgraph[order(up.forgraph$Estimate), ]
up.forgraph$asvtaxa <- factor(up.forgraph$asvtaxa, levels = as.vector(up.forgraph$asvtaxa))

mycolors <- c("#1B9E77","#CC79A7","#660066","yellow","red","blue")
names(mycolors)<-c("Aquarickettsia","Spirochaeta_2","Family_Helicobacteraceae","Romboutsia","Cetobacterium","Unclassified_ASV_12")
mycolors

lowmid<-ggplot(mid.forgraph, aes(x = asvtaxa, y = Estimate, fill = Genus)) +
  geom_errorbar(aes(ymin = Estimate-StdError, ymax = Estimate+StdError), color = "black", width = .3, position=position_dodge(.9)) +
  geom_point(size = 3, pch = 21) + 
  scale_x_discrete(limits = rev(levels(mid.forgraph$asvtaxa))) +
  scale_fill_manual(values = mycolors) +
  geom_line() +
  coord_flip() +
  theme_bw() +
  labs(x = " ", y = "Coefficient",family="Times New Roman") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")+
  theme(legend.position = "none",axis.text.x=element_text(family="Times New Roman",size=12),axis.text.y=element_text(family="Times New Roman",size=12))+
  annotate("text",x=10.2,y=-3.9,label="Lower Keys",family="Times New Roman",size=3)+
  annotate("text",x=10.2,y=1.1,label="Middle Keys",family="Times New Roman",size=3)
lowmid

lowup<-ggplot(up.forgraph, aes(x = asvtaxa, y = Estimate, fill = Genus)) +
  geom_errorbar(aes(ymin = Estimate-StdError, ymax = Estimate+StdError), color = "black", width = .3, position=position_dodge(.9)) +
  geom_point(size = 3, pch = 21) +
  scale_x_discrete(limits = rev(levels(up.forgraph$asvtaxa))) +
  scale_fill_manual(values = mycolors) +
  geom_line() +
  coord_flip() +
  theme_bw() +
  labs(x = "", y = "Coefficient",family="Times New Roman") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")+theme(axis.text.y=element_blank(),legend.position="none",axis.text.x=element_text(family="Times New Roman",size=12))+
  annotate("text",x=10.2,y=-4.8,label="Lower Keys",family="Times New Roman",size=3)+
  annotate("text",x=10.2,y=1.5,label="Upper Keys",family="Times New Roman",size=3)
lowup

out.forgraph <- sigtaxto_df_2options(da_analysis_out, ps_out_nr,2) #make a df of the corncob output and the taxonomy
#Change the levels of the $asvtaxa row so that it reorders the plot by decreasing coefficients
#up.forgraph <- up.forgraph[order(up.forgraph$Estimate), ]
out.forgraph$asvtaxa <- factor(out.forgraph$asvtaxa, levels = as.vector(out.forgraph$asvtaxa))
outcorn<-ggplot(out.forgraph, aes(x = asvtaxa, y = Estimate, fill = Genus)) +
  geom_errorbar(aes(ymin = Estimate-StdError, ymax = Estimate+StdError), color = "black", width = .3, position=position_dodge(.9)) +
  geom_point(size = 3, pch = 21) +
  scale_x_discrete(limits = rev(levels(out.forgraph$asvtaxa))) +
  scale_fill_manual(values = mycolors) +
  geom_line() +
  coord_flip() +
  theme_bw() +
  labs(x = "", y = "Coefficient", title = expression(italic("Low Aquarickettsia Lower vs Upper Keys"))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")+theme(legend.position="none")

```

```{r}
(outcorn)

```


## bubble plot
```{r}
sample_variables(ps)
variable1 = as.character(get_variable(ps, "Region"))
variable2 = as.character(get_variable(ps, "Outlier"))

sample_data(ps)$Region.Outlier <- mapply(paste, variable1, variable2, sep = " ")
levels(as.factor(sample_data(ps)$Region.Outlier))
physeq.f<-merge_samples(ps,"Region.Outlier")
sample_data(physeq.f)

physeq.f.ra <- transform_sample_counts(physeq.f, function(x) x*100/sum(x))
#look at graces code and do mean!
#want ASV_1, ASV_2, ASV_5, ASV_8, ASV_10,ASV_12, ASV_14, ASV_17, ASV_38, ASV_43
p<-physeq.f.ra

o<-otu_table(p)
propData <- as.data.frame(o)
sample_data(p)$Region.Outlier<-rownames(sample_data(p))
t<-data.frame(cbind(levels(as.factor(sample_data(p)$Region.Outlier))))
t <-cbind(t,propData$ASV_1,propData$ASV_2,propData$ASV_5,propData$ASV_8,propData$ASV_10,propData$ASV_12, propData$ASV_14,propData$ASV_17,propData$ASV_38,propData$ASV_43)
colnames(t)<-c("Region.Outlier","ASV_1", "ASV_2", "ASV_5", "ASV_8", "ASV_10","ASV_12", "ASV_14", "ASV_17", "ASV_38","ASV_43")
highlow<-c("High-Aquarickettsia","Low-Aquarickettsia","High-Aquarickettsia","High-Aquarickettsia","Low-Aquarickettsia")
region<-c("Lower Keys","Lower Keys","Middle Keys","Upper Keys","Upper Keys")
t<-cbind(highlow,region,t)
pcm = melt(t, id.vars = c("Region.Outlier","region","highlow")) #convert data frame from a "wide" format to a "long" format

mycolors2 <- c("#1B9E77","#CC79A7","#1B9E77","#CC79A7","#660066","blue","#1B9E77","red","#1B9E77","#1B9E77")
names(mycolors2)<-levels(pcm$variable)
mycolors2
levels(pcm$variable)<-c("Aquarickettsia (ASV_1)","Spirochaeta_2 (ASV_2)","Aquarickettsia (ASV_5)","Spirochaeta_2 (ASV_8)","Family_Helicobacteraceae (ASV_10)","Unclassified_ASV_12 (ASV_12)","Aquarickettsia (ASV_14)","Cetobacterium (ASV_17)",'Aquarickettsia (ASV_38)',"Aquarickettsia (ASV_43)")
names(mycolors2)<-levels(pcm$variable)
xx<-ggplot(pcm, aes(x = region, y = variable,fill=variable)) + 
  geom_point(aes(size = as.numeric(value)), alpha = 0.75, shape = 21) +  
  scale_size_continuous(limits = c(0.00001, 100), range = c(1,12), breaks = c(.1,1,5,10,50,95)) +  
  labs( x= "", y = "", size = "Mean Relative abundance", fill = "")  +  
  theme(legend.key=element_blank()) +
  scale_fill_manual(values = mycolors2,guide=FALSE) +
  theme_bw()+
  scale_y_discrete(limits = rev(levels(pcm$variable)))+
  facet_grid(~highlow, scales = "free_x", space = "free_x")+
  theme(legend.position = "right", axis.text.y = element_text(family="Times New Roman", size = 12),axis.text.x = element_text(colour = "black", size = 10, angle = 30, hjust = 1,family="Times New Roman"))
xx
```

```{r,fig.width=9,fig.height=8}
fig6<-(((lowmid+theme(text = element_text(family = "Times New Roman",size=12)))+lowup)+theme(text = element_text(family = "Times New Roman",size=12))) / xx +plot_annotation(tag_levels="A")+theme(text = element_text(family = "Times New Roman",size=12))
fig6

#ggsave("Figure6.png", plot = fig6, width = 25, height = 25, units = "cm", dpi = 300)

```

## Temporal differences

### Time averages and such full data set
```{r}
dat<-data.frame(sample_data(ps))
mean(dat$Max.Years.Spent.in.Nursery,na.rm = TRUE)
mean(subset(dat,subset=Region!="Lower Keys")$Max.Years.Spent.in.Nursery,na.rm = TRUE)
mean(dat$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
median(dat$Max.Years.Spent.in.Nursery,na.rm = TRUE)
median(dat$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
range(dat$Max.Years.Spent.in.Nursery,na.rm = TRUE)
range(dat$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
sd(dat$Max.Years.Spent.in.Nursery,na.rm = TRUE)
sd(dat$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
std.error(dat$Max.Years.Spent.in.Nursery,na.rm = TRUE)
std.error(dat$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
```
## Time averages and such by region
```{r}
datlow <- data.frame(sample_data(ps_low))
datmid <- data.frame(sample_data(ps_mid))
 datup <- data.frame(sample_data(ps_up))
length(datlow$Sample.ID)
length(datmid$Sample.ID)
length(datup$Sample.ID)
mean(datup$Max.Years.Spent.in.Nursery,na.rm = TRUE)
mean(datup$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
median(datup$Max.Years.Spent.in.Nursery,na.rm = TRUE)
median(datup$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
range(datmid$Max.Years.Spent.in.Nursery,na.rm = TRUE)
range(datup$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
sd(datup$Max.Years.Spent.in.Nursery,na.rm = TRUE)
sd(datup$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
std.error(datup$Max.Years.Spent.in.Nursery,na.rm = TRUE)
std.error(datup$Max.Years.Spent.from.Original.Collection,na.rm = TRUE)
range(datlow$Max.Years.Spent.in.Nursery,na.rm=TRUE)

hist(datup$Max.Years.Spent.in.Nursery)

hist(datmid$Max.Years.Spent.in.Nursery)

hist(datlow$Max.Years.Spent.in.Nursery)
```

## Time normality test
```{r}
fit1 <- aov((Max.Years.Spent.in.Nursery)~Region,data=dat)
shapiro.test(fit1$residuals)
summary(fit1)

```

### Time data is not normal, act accordingly
## Time Kruskal Wallis test
```{r}
kruskal.test(Max.Years.Spent.in.Nursery~Region,data=dat)
```


## Time Pairwise Kruskal Wallis Test
### Max.Years.Spent.in.Nursery
```{r}
timeregpairkruskal<-function(p){
  sampledf<-data.frame(sample_data(p))
  sampledf$Region<-as.factor(sampledf$Region)
  region.list<-levels(sampledf$Region)
  region.list
  aovresults<-c()
  pvals<-c()
  locations<-c()
  for (i in 1:length(region.list)){
    region.leftout<-region.list[i]
    date_sub<-subset(sampledf,Region!=region.leftout) #instead of subset_samples use a subset() for the dataframe you are working with
    #d.sub<-phyloseq::distance(ps_sub, "bray") # won't need this for kruskal
    #df.new<-subset(sampledf,subset=Region!=region.leftout) # won't need this either
    PERM<-kruskal.test(Max.Years.Spent.in.Nursery~Region,date_sub) #change to kruskal
    print(PERM)
    pvals<-c(pvals,PERM$'p.value') #this will change. run a kruskal and save the output to do str(output) to see what it call's the pvalues that it outputs.
    #aovresults<-rbind(aovresults,PERM$aov.tab) 
    loc.sub<-region.list[-i]
    locations<-rbind(locations,c(loc.sub))
  }
  aovresults
  combinedtest<-cbind(locations,pvals)
  mult_perm<-data.frame(combinedtest)
  mult_perm
  mult_perm$pvaladj<-p.adjust(mult_perm$pvals,method="bonferroni")
  mult_perm
}
noouttimeregpait<-timeregpairkruskal(psnoout)
noouttimeregpait
###NO OUTLIERS INCLUDED SINCE ONLY 2 GROUPS (LOW AND UP)
```




## diversity versus time

### kruskal-wallis outlier by time
```{r}
kruskal.test(Max.Years.Spent.in.Nursery~Outlier,data = full_alpha)
```

```{r}
fit1 <- lm(shannon1~Max.Years.Spent.in.Nursery,data=subset(noout_alpha,subset=Region!="Lower Keys"))
shapiro.test(fit1$residuals)
summary(fit1)

shan.div.plot.midup<-ggplot(fit1$model, aes(x =Max.Years.Spent.in.Nursery,y=shannon1)) + geom_point()+
   stat_smooth(method = "lm", col = "red",se=TRUE,size=.5,alpha=0.1,lty=2)+
  theme(panel.background = element_blank())+ 
  theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(legend.position="None")+
  labs(x="time spent in nursery",y="shannon diversity")
shan.div.plot.midup

fit2 <- lm(log(shannon1)~Max.Years.Spent.in.Nursery,data=subset(noout_alpha,subset=Region=="Lower Keys"))
shapiro.test(fit2$residuals)
summary(fit2)
fit2$model
shan.div.plot.lower<-ggplot(fit2$model, aes(x =Max.Years.Spent.in.Nursery,y=`log(shannon1)`)) +
  geom_point()+
   stat_smooth(method = "lm", col = "red",se=TRUE,size=.5,alpha=0.1,lty=2)+
  theme(panel.background = element_blank())+ 
  theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(legend.position="None")+
  labs(x="time spent in nursery",y="log(shannon diversity)")
shan.div.plot.lower


```
```{r}
fit1 <- lm(1/log(rich1)~Max.Years.Spent.in.Nursery,data=subset(noout_alpha,subset=Region!="Lower Keys"))
shapiro.test(fit1$residuals)
summary(fit1)

rich.plot.midup<-ggplot(fit1$model, aes(x =Max.Years.Spent.in.Nursery,y=`1/log(rich1)`)) + geom_point()+
   stat_smooth(method = "lm", col = "red",se=TRUE,size=.5,alpha=0.1,lty=2)+
  theme(panel.background = element_blank())+ 
  theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(legend.position="None")+
  labs(x="time spent in nursery",y="1/log(Richness)")
rich.plot.midup

fit2 <- lm(log(rich1)~Max.Years.Spent.in.Nursery,data=subset(noout_alpha,subset=Region=="Lower Keys"))
shapiro.test(fit2$residuals)
summary(fit2)

rich.plot.lower<-ggplot(fit2$model, aes(x =Max.Years.Spent.in.Nursery,y=`log(rich1)`)) +
  geom_point()+
   stat_smooth(method = "lm", col = "red",se=TRUE,size=.5,alpha=0.1)+
  theme(panel.background = element_blank())+ 
  theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  theme(legend.position="None")+
  labs(x="time lower keys genotypes spent in nursery",y="log(Richness)")
rich.plot.lower


```

# ### now beta diversity
```{r}
p<-psnoout # nooutlier dataset
sampledf<-data.frame(sample_data(p))
sampledf$Region <- as.factor(sampledf$Region)
d_mat<-phyloseq::distance(p, "bray")
g_mod<-with(sampledf,betadisper(d_mat,Region))
g_mod$distances

noout_alpha$distances<-g_mod$distances

fit1 <- lm((distances)~Max.Years.Spent.in.Nursery,data=subset(noout_alpha,subset=Region!="Lower Keys"))
shapiro.test(fit1$residuals)
summary(fit1)


fit2<- lm(1/sqrt(distances)~Max.Years.Spent.in.Nursery,data=subset(noout_alpha,subset=Region=="Lower Keys"))
shapiro.test(fit2$residuals)
summary(fit2)
```
Because the time spent in the nursery is fairly "grouped" (see histograms), going to bin the data into short and long term in nursery for the lower keys genotypes

```{r}
lk.alpha<-subset(full_alpha,subset=Region=="Lower Keys")
lk.alpha$timebin<-ifelse(lk.alpha$Max.Years.Spent.in.Nursery<=5.86,"short","long")
t.test(subset(lk.alpha,lk.alpha$timebin=="long")$rich1,subset(lk.alpha,lk.alpha$timebin=="short")$rich1)
```


### How many ASVs of? Aquarickettsia

## relative abundances
### make mycolors
```{r}
physeq.f<-phyloseq::filter_taxa(ps_acer, function(x) sum(x >= 100) > (0.01*length(x)), prune = TRUE) #filter out super small numbers
physeq.f 

physeq.f.ra <- transform_sample_counts(physeq.f, function(x) x*100/sum(x))
physeq.f.ra.ord <- subset_taxa(physeq.f.ra,Genus=="Aquarickettsia")

propData <- as.data.frame((otu_table(physeq.f.ra.ord)))
plotDF <- propData %>%
  rownames_to_column(var="taxa") %>%
  melt() %>%
  magrittr::set_names(c("sample", "taxa", "relab"))
head(plotDF)#just checking it worked
taxonomy.2 <- tax_table(physeq.f) %>%
  as.data.frame() %>%
  rownames_to_column(var="taxa")
head(taxonomy.2)#just checking it worked
head(plotDF)#just checking it worked
plotDF <- left_join(plotDF, taxonomy.2, by="taxa") %>%
  select(taxa, sample, relab, taxa) #would need to update here too if you change it.
head(plotDF)#just checking it worked

sampdata<-data.frame(sample_data(physeq.f.ra.ord)) #make dataframe of the sample data
metadata.2 <- sampdata %>%
  rownames_to_column(var="sample") #make a column of rownames (sample)
head(metadata.2)

#combine plotDF1 and metadata.2 by sample name
plotDF <- left_join(plotDF, metadata.2, by="sample") 
head(plotDF) #just checking it worked

```


#### set colors
```{r}
length(levels(factor(plotDF$taxa)))
mycolors <- c("#1B9E77","aquamarine3","cadetblue3","turquoise1","turquoise4")
names(mycolors)<-levels(factor(plotDF$taxa))
mycolors
#mycolors<-c("#999999", "#FFFF00",  "#CC3300","#0072B2","#660066", "#E69F00", "#56B4E9","#CC79A7","#1B9E77","#AAE247") #colors used by Grace?
```

```{r}
#plotDF<-plotDF[order(plotDF$Outlier),]
#plotDF$sample[6133:6142]
#plotDF$sample<-factor(plotDF$sample,levels=c(plotDF$sample[1:64],plotDF$sample[6133:6142]))
plotDF2<-subset(plotDF,subset=Outlier=="No")
ggplot(plotDF2, aes(x=X2020_Mote_ID, relab, fill=taxa)) + 
  #make it a barplot with classes stacked on top of each other
  geom_bar(stat="identity", position = "stack",aes(fill = reorder(taxa, -relab))) + 
  #set x-axis labels to be oriented vertically, and set the size of the text to 6.5
  theme(axis.text.x = element_text(angle = 90,size = 6.5)) + 
  #set the colors being filled in by class to the mycolors variable made earlier
  scale_fill_manual(values = mycolors,limits = levels(plotDF$Genus)) + 
  #facet wrap (separate out) by Region
  facet_grid(~Region,space="free_x",scales="free_x",drop=TRUE) + 
  #set legend title size to 8 and legend text size to 6
  theme(legend.title = element_text(size = 8),legend.text = element_text(size = 6),legend.position = "bottom")+
  xlab("2020 Mote ID")+
  ylab("% Relative Abundance")+
  coord_cartesian(ylim=c(0,5))

```

### ASV1
From Reviewer 2: It is strange that Aquarickettsia ASV1 was detected as differentially abundant in the Lower Keys compared to both the Middle and Upper Keys (Panels A & B) when the relative abundance of this ASV1 is very similar across regions (Panel C). If you plotted the relative abundance of ASV1 for each genotype in a box & whisker plot (like figs. 4, 5) would it show the pattern behind this?

```{r}
asv1<-subset(plotDF2,taxa=="ASV_1")
boxplot(asv1$relab~asv1$Region,ylim=c(70,100),ylab="Relative abundance of ASV 1",xlab="Initial Collection Region")
```

